let player;
let trv;
let joyCon;

/* --- youtube player */

/* load youtube js api */
!(function () {
  const script = document.createElement('script');
  script.src = "https://www.youtube.com/iframe_api";
  document.head.appendChild(script);
})();

/* this function is called automatically when the iframe_api is ready */
function onYouTubeIframeAPIReady () {
  player = new YT.Player("player", {
    videoId: "N_ATbQLVQjE",
    playerVars: {
      loop: 1,
      autoplay: 1,
      playsinline: 1,
      enablejsapi: 1,
    },
    events: {
      onReady: function () {
        document.getElementById("videoStatus").innerHTML = "LOADED";
        player.setVolume(0);
        player.setLoop(true);
        player.seekTo(6);
        player.playVideo();
      },
    },
  });
}

/* --- trance vibrator */

async function sendTrv (value) {
  if (trv) {
    await trv.controlTransferOut({
      requestType: "vendor",
      recipient: "interface",
      request: 1,
      value: value,
      index: 0,
    });
  }
}

async function connectTrv () {
  if (!navigator.usb) {
    alert("WebUSB unsupported on your browser");
    return;
  }
  trv = await navigator.usb.requestDevice({
    filters: [
      { vendorId: 0x0b49, productId: 0x064f },
    ],
  });
  await trv.open();
  await trv.selectConfiguration(1);
  await trv.claimInterface(0);
  await sendTrv(128);
  setTimeout(function () { sendTrv(0); }, 250);
  document.getElementById("trvStatus").innerHTML = "CONNECTED";
}

/* --- Joy-Con, Pro-Con */

async function connectJoyCon () {
  joyCon = new JoyCon();
  await joyCon.connect();
  document.getElementById("joyConStatus").innerHTML = "CONNECTED";
}

/* --- built-in vibrator  */

let vibEnabled = false;

function enableVib () {
  if (!navigator.vibrate) {
    alert("Vibration API unsupported on your browser");
    return;
  }
  vibEnabled = true;
  navigator.vibrate(250);
  document.getElementById("vibStatus").innerHTML = "ENABLED";
}

let vibratingState = false;
function sendVib (value) {
  const newVibratingState = value > 128 ? true : false;
  if (vibEnabled && vibratingState != newVibratingState) {
    navigator.vibrate(newVibratingState ? 1000 : 0);
    vibratingState = newVibratingState;
  }
}

/* --- songs */

function withBPM (bpm, arr) {
  return (time) => arr[Math.floor(time * bpm * 4 / 60)] || 0;
}

const track1a = withBPM(140, [
  /* kick: 0xff 0x7f */
  /* 1                    2                       3                       4                   */
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0xbf, 0x7f, 0xbf, 0x7f, 0xbf, 0x7f, 0xbf, 0x7f, 0xbf, 0x7f, 0xbf, 0x7f, 0xbf, 0x7f, 0xbf, 0x7f,
  0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00,
  0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00,
  0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00,
  0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x7f,
  0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00,
  0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00,
  0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00,
  0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x7f, 0xff, 0x7f, 0xff, 0x7f, 0xff, 0x7f, 0xff, 0x7f,
  0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00,
]);

const track1b = withBPM(140, [
  /* synth: 0x7f 0xbf 0xff */
  /* 1                    2                       3                       4                   */
  0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xbf, 0xff, 0x7f, 0xff, 0x7f, 0xff, 0x7f,
  0xbf, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xbf, 0xff, 0x7f, 0xff, 0x7f, 0xff, 0x7f,
  0xbf, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xbf, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00,
]);

const track2a = withBPM(142, [
  /* base kick pattern: 0xff 0xbf 0x7f */
  /* 1                    2                       3                       4                   */
  0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00,
  0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00,
  0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00,
  0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00,
  0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00,
  0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00,
  0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00,
  0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00,
  0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00,
  0xff, 0xbf, 0x7f, 0x00, 0xff, 0xbf, 0x7f, 0x00,
]);

const track3 = withBPM(138, [
  /* base kick pattern: 0xff */
  /* 1                    2                       3                       4                   */
  0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00,
  0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff, 0x00,
  0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00,
  0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff, 0x00,
  0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00,
  0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff, 0x00,
  0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00,
  0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff, 0x00,
]);

const track4 = withBPM(140, [
  /* base kick pattern: 0xff 0xbf 0x7f 0x3f */
  /* 1                    2                       3                       4                   */
  0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f,
  0xff, 0x7f, 0xff, 0x7f, 0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f,
  0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f,
  0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f,
  0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f,
  0xff, 0x7f, 0xff, 0x7f, 0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f,
  0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f,
  0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f,
  0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f, 0xff, 0xbf, 0x7f, 0x3f,
  0xff, 0x7f, 0xff, 0x7f, 0x3f, 0x00, 0x00, 0x00,
]);

const track5 = withBPM(90, [
  /* intro */
  /* 1                    2                       3                       4                   */
  0xff, 0xff, 0xaf, 0xaf, 0x9f, 0x9f, 0x9f, 0x9f, 0x8f, 0x8f, 0x8f, 0x8f, 0x7f, 0x7f, 0x7f, 0x7f,
  0x6f, 0x6f, 0x6f, 0x6f, 0x5f, 0x5f, 0x5f, 0x5f, 0x4f, 0x4f, 0x4f, 0x4f, 0x3f, 0x3f, 0x3f, 0x3f,
  0xaf, 0xaf, 0xaf, 0xaf, 0x9f, 0x9f, 0x9f, 0x9f, 0x8f, 0x8f, 0x8f, 0x8f, 0x7f, 0x7f, 0x7f, 0x7f,
  0x6f, 0x6f, 0x6f, 0x6f, 0x5f, 0x5f, 0x5f, 0x5f, 0x4f, 0x4f, 0x4f, 0x4f, 0x3f, 0x3f, 0x3f, 0x3f,
  0xaf, 0xaf, 0xaf, 0xaf, 0x9f, 0x9f, 0x9f, 0x9f, 0x8f, 0x8f, 0x8f, 0x8f, 0x7f, 0x7f, 0x7f, 0x7f,
  0x6f, 0x6f, 0x6f, 0x6f, 0x5f, 0x5f, 0x5f, 0x5f, 0x4f, 0x4f, 0x4f, 0x4f, 0x3f, 0x3f, 0x3f, 0x3f,
  0xaf, 0xaf, 0xaf, 0xaf, 0x9f, 0x9f, 0x9f, 0x9f, 0x8f, 0x8f, 0x8f, 0x8f, 0x7f, 0x7f, 0x7f, 0x7f,
  0x9f, 0x00, 0x9f, 0x00, 0x5f, 0x6f, 0x7f, 0x8f, 0x9f, 0x6f, 0x00, 0x00, 0x9f, 0x6f, 0x00, 0x00,
  /* base kick pattern: 0xff 0xbf 0x7f */
  /* 1                    2                       3                       4                   */
  0x9f, 0x6f, 0x9f, 0x6f, 0xff, 0xbf, 0x7f, 0x00, 0x9f, 0x6f, 0x00, 0x9f, 0xff, 0xbf, 0x7f, 0x6f,
  0x9f, 0x6f, 0x9f, 0x6f, 0xff, 0xbf, 0x7f, 0x00, 0x9f, 0x6f, 0x00, 0x9f, 0xff, 0xbf, 0x7f, 0x6f,
  0x9f, 0x6f, 0x9f, 0x6f, 0xff, 0xbf, 0x7f, 0x00, 0x9f, 0x6f, 0x00, 0x9f, 0xff, 0xbf, 0x7f, 0x6f,
  0x9f, 0x6f, 0x9f, 0x6f, 0xff, 0xbf, 0x7f, 0x8f, 0x9f, 0x8f, 0x70, 0x6f, 0xff, 0xbf, 0x7f, 0x6f,
  0x9f, 0x6f, 0x9f, 0x6f, 0xff, 0xbf, 0x7f, 0x00, 0x9f, 0x6f, 0x00, 0x9f, 0x00, 0x00, 0x00, 0x6f,
  0x9f, 0x6f, 0x9f, 0x6f, 0xff, 0xbf, 0x7f, 0x00, 0x9f, 0x6f, 0x00, 0x9f, 0xff, 0xbf, 0x7f, 0x6f,
  0x9f, 0x6f, 0x9f, 0x6f, 0xff, 0xbf, 0x7f, 0x00, 0x9f, 0x6f, 0x00, 0x9f, 0xbf, 0x7f, 0x3f, 0x6f,
]);

const FADE_DURATION = 1;
function fade (beg, end, time) {
  return Math.max(
    0,
    Math.min(1, (time - beg) / FADE_DURATION + 1) * Math.min(1, (end - time) / FADE_DURATION + 1)
  );
}

function vibrationValue (time) {
  return Math.min(
    255,
    fade( 0.35, 21.90, time) * (1.0 * track1a(time -  0.35) + 0.5 * track1b(time - 0.35)) +
    fade(22.90, 37.95, time) * track2a(time - 22.40) +
    track3(time - 38.45) +
    track4(time - 52.35) +
    track5(time - 73.90)
  );
}

/* --- entrypoint */

const timeEl = document.getElementById("time");
function monitorPlayerStatus () {
  switch (player.getPlayerState()) {
    case 1:
      const time = player.getCurrentTime();
      const value = vibrationValue(time);
      sendTrv(value);
      if (joyCon) joyCon.send(value / 255);
      sendVib(value);
      timeEl.innerHTML = time;
      document.body.style.setProperty("--vib1", value / 255);
      break;
    default:
      sendTrv(0);
      if (joyCon) joyCon.send(0);
      sendVib(0);
      timeEl.innerHTML = "(paused)";
      document.body.style.setProperty("--vib1", 0);
  }
}

function play () {
  if (!player) {
    alert("Video is not loaded. Please reload this page if it does not load.");
    return;
  }
  player.seekTo(0);
  player.unMute();
  player.setVolume(100);
  setInterval(monitorPlayerStatus, 30);
  document.getElementById("setup").remove();
  document.getElementById("control").style.display = "block";
}
